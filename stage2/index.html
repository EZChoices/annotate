<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoAtlas Stage 2 — Deep Annotation</title>
  <link rel="manifest" href="/public/manifest.webmanifest">
  <link rel="stylesheet" href="/public/styles.css">
  <style>
    .hide{display:none}
    .screen{max-width:720px;margin:0 auto}
    .controls{display:flex;gap:.5rem;margin:.5rem 0}
    textarea.vtt{width:100%;min-height:140px}
    .notice{background:var(--card);border:1px solid var(--border);padding:.6rem .9rem;border-radius:10px}
    .notice.error{border-color:#c0392b;color:#7f1d1d}
    .notice.warn{border-color:#f39c12;color:#7a4f00}
    .translation-list{display:flex;flex-direction:column;gap:.75rem;margin:.75rem 0}
    .translation-row{display:grid;gap:.5rem;grid-template-columns:1fr;align-items:start;border:1px solid var(--border);border-radius:10px;padding:.75rem;background:var(--card)}
    .translation-row__header{display:flex;justify-content:space-between;align-items:center;gap:.75rem;font-size:.9rem;color:var(--muted);flex-wrap:wrap}
    .translation-row__original{background:rgba(0,0,0,0.04);padding:.5rem .65rem;border-radius:6px;font-size:.95rem;line-height:1.4}
    .translation-row__input{width:100%;min-height:72px}
    .translation-row.missing .translation-row__header{color:#b04a00}
    .translation-row__alert{color:#b04a00;font-size:.85rem;margin-top:.25rem}
    .translation-sticky{position:sticky;top:0;background:var(--bg);padding:.5rem 0;z-index:5}
    .diar-timeline{position:relative;height:24px;border:1px solid var(--border);border-radius:8px;background:var(--card);margin:.75rem 0 .25rem;overflow:hidden}
    .diar-timeline.empty{opacity:.65}
    .diar-seg{position:absolute;top:0;bottom:0;border-radius:6px;background:var(--diar-color,rgba(52,152,219,0.55));box-shadow:0 0 0 1px rgba(0,0,0,0.18);cursor:pointer;transition:box-shadow .15s ease,transform .15s ease}
    .diar-seg:hover{box-shadow:0 0 0 2px rgba(0,0,0,0.2);transform:translateY(-1px)}
    .diar-seg.selected{box-shadow:0 0 0 2px var(--accent)}
    .diar-row{display:flex;gap:.5rem;align-items:center;margin:.25rem 0;padding:.1rem .3rem;border-radius:6px;transition:background .15s ease}
    .diar-row.selected{background:rgba(43,124,255,0.08)}
    .cs-timeline{position:relative;height:72px;border:1px solid var(--border);border-radius:10px;background:var(--card);margin:.75rem 0;overflow:hidden}
    .cs-span{position:absolute;top:12px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.85rem;color:#fff;cursor:pointer;box-shadow:0 0 0 1px rgba(0,0,0,0.12);transition:box-shadow .15s ease}
    .cs-span__label{pointer-events:none}
    .cs-span.selected{box-shadow:0 0 0 2px var(--accent)}
    .cs-span.active-preview{opacity:.6;pointer-events:none}
    .cs-span--eng{background:rgba(43,124,255,0.35);border:1px solid rgba(43,124,255,0.6)}
    .cs-span--fra{background:rgba(155,89,182,0.35);border:1px solid rgba(155,89,182,0.6)}
    .cs-span--other{background:rgba(22,160,133,0.35);border:1px solid rgba(22,160,133,0.6)}
    .cs-handle{position:absolute;top:0;width:10px;height:100%;background:rgba(255,255,255,0.85);cursor:ew-resize}
    .cs-handle.start{left:0;border-radius:8px 0 0 8px}
    .cs-handle.end{right:0;border-radius:0 8px 8px 0}
    .cs-toast{position:fixed;left:50%;bottom:1.5rem;transform:translateX(-50%);background:rgba(33,33,33,0.92);color:#fff;padding:.6rem 1.2rem;border-radius:999px;box-shadow:0 8px 24px rgba(0,0,0,0.25);opacity:0;pointer-events:none;transition:opacity .2s ease}
    .cs-toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="container">
    <div class="screen" id="screen_welcome">
      <h2>Verify transcript, translation, and mark code-switches.</h2>
      <p class="notice hide" id="offlineNotice">You're offline. Work is saved locally and will sync automatically.</p>
      <div id="downloadStatus" class="notice">Ready. Tap Start to load tasks.</div>
      <button id="startBtn" class="primary">Start</button>
    </div>

    <div class="screen hide" id="screen_transcript">
      <h3>Transcript — keep cues 0.6–6.0s, no overlaps</h3>
      <audio id="audio" controls preload="auto"></audio>
      <canvas id="wave" style="width:100%;height:80px;margin:.4rem 0;background:var(--card);border:1px solid var(--border);border-radius:8px"></canvas>
      <div class="controls">
        <button id="zoomOut" class="secondary">- Zoom</button>
        <button id="zoomIn" class="secondary">+ Zoom</button>
        <button id="scrollLeft" class="secondary">◀︎</button>
        <button id="scrollRight" class="secondary">▶︎</button>
      </div>
      <div class="controls">
        <button id="splitBtn" class="secondary">Split</button>
        <button id="splitAllBtn" class="secondary">Split All</button>
        <button id="mergeBtn" class="secondary">Merge</button>
        <button id="rewindBtn" class="secondary">Rewind 3s</button>
        <button id="undoBtn" class="secondary">Undo</button>
      </div>
      <div id="timeline" style="height:32px;border:1px solid var(--border);border-radius:6px;position:relative;background:var(--card)"></div>
      <label>Cues (WebVTT)</label>
      <textarea id="transcriptVTT" class="vtt" placeholder="WEBVTT\n\n00:00.000 --> 00:02.000\nHello"></textarea>
      <div class="controls">
        <button id="transcriptNext" class="primary">Approve Transcript</button>
      </div>
    </div>

    <div class="screen hide" id="screen_translation">
      <h3>Translation — one translation per cue</h3>
      <label style="display:flex;align-items:center;gap:.5rem"><input type="checkbox" id="lockTranslation" checked> Lock translation timings to transcript</label>
      <div class="translation-sticky notice warn hide" id="translationStickyNotice"></div>
      <div id="translationList" class="translation-list" aria-live="polite"></div>
      <textarea id="translationVTT" class="vtt hide" aria-hidden="true" tabindex="-1"></textarea>
      <div class="controls">
        <button id="translationNext" class="primary">Approve Translation</button>
      </div>
    </div>

    <div class="screen hide" id="screen_codeswitch">
      <h3>Code-Switch — press while the switch lasts</h3>
      <div class="controls">
        <button class="secondary" data-lang="eng" id="btnEN">EN</button>
        <button class="secondary" data-lang="fra" id="btnFR">FR</button>
        <button class="secondary" data-lang="other" id="btnOther">Other</button>
        <button class="secondary" id="csUndo">Undo</button>
        <button class="secondary" id="csRedo">Redo</button>
      </div>
      <div class="controls">
        <button class="secondary" id="nudgeStartMinus">Start -200ms</button>
        <button class="secondary" id="nudgeStartPlus">Start +200ms</button>
        <button class="secondary" id="nudgeEndMinus">End -200ms</button>
        <button class="secondary" id="nudgeEndPlus">End +200ms</button>
      </div>
      <div id="diarTimeline" class="diar-timeline" aria-label="Speaker diarization timeline"></div>
      <div id="codeSwitchTimeline" class="cs-timeline" aria-live="polite"></div>
      <div id="codeSwitchNotice" class="notice warn hide"></div>
      <textarea id="codeSwitchVTT" class="vtt hide" aria-hidden="true" tabindex="-1"></textarea>
      <div class="controls">
        <button id="csNext" class="primary">Continue</button>
      </div>
    </div>
      
          <div class="screen hide" id="screen_speaker">
      <h3>Speaker Attributes (per speaker)</h3>
      <div id="speakerCards"></div>
      <div class="controls">
        <button id="speakerNext" class="primary">Continue</button>
      </div>
    </div>

    <div class="screen hide" id="screen_emotion">
      <h3>Emotion (optional)</h3>
      <div class="controls">
        <button id="btnNeutral" class="secondary">Neutral</button>
        <button id="btnHappy" class="secondary">Happy</button>
        <button id="btnAngry" class="secondary">Angry</button>
        <button id="btnSad" class="secondary">Sad</button>
        <button id="btnExcited" class="secondary">Excited</button>
        <button id="btnOtherEmo" class="secondary">Other</button>
        <button id="emoUndo" class="secondary">Undo</button>
      </div>
      <label>Emotion Spans (WebVTT)</label>
      <textarea id="emotionVTT" class="vtt" placeholder="WEBVTT\n\n00:00.000 --> 00:01.500\nneutral\n"></textarea>
      <div class="controls">
        <button id="emotionNext" class="primary">Continue</button>
      </div>
    </div>
    <div class="screen hide" id="screen_pii">
      <h3>Optional PII / Safety Events</h3>
      <div class="controls">
        <button class="secondary" data-evt="pii_name">PII: Name</button>
        <button class="secondary" data-evt="pii_phone">PII: Phone</button>
        <button class="secondary" data-evt="minor_face">Minor Face</button>
        <button class="secondary" data-evt="political_slogan">Political</button>
        <button class="secondary" data-evt="religious_content">Religious</button>
        <button class="secondary" data-evt="explicit">Explicit</button>
      </div>
      <label>Events (WebVTT)</label>
      <textarea id="eventsVTT" class="vtt" placeholder="WEBVTT\n\n00:01.000 --> 00:03.200\npii_name"></textarea>
      <div class="controls">
        <button id="piiNext" class="primary">Continue</button>
      </div>
    </div>

    <div class="screen hide" id="screen_diar">
      <h3>Diarization (Optional)</h3>
      <p class="notice">Nudge boundaries up to 500ms. Prefill loads from keep table if provided.</p>
      <div id="diarList" class="notice"></div>
      <div class="controls">
        <button id="diarNext" class="primary">Continue</button>
      </div>
    </div>

    <div class="screen hide" id="screen_review">
      <h3>Review & Submit</h3>
      <div id="errorsList" class="notice hide"></div>
      <div class="controls">
        <button id="submitBtn" class="primary">Submit & Next</button>
      </div>
      <div class="controls">
        <button id="clearLocal" class="secondary">Clear Local Data</button>
      </div>
    </div>
  </div>
  <div id="csToast" class="cs-toast" role="status" aria-live="polite"></div>

  <script src="/public/idb.js"></script>
  <script src="/public/env.js"></script>
  <script src="/public/config.js"></script>
  <script src="/public/vtt.js"></script>
  <script src="/public/timeline.js"></script>
  <script src="/public/waveform.js"></script>
  <script src="/stage2/app.js"></script>
  <script>
    // Quick Links footer for easy switching/debug
    (function(){
      const c = document.createElement('div');
      c.className = 'notice';
      const base = location.origin;
      const annotKey = 'ea_stage2_annotator_id';
      let id = 'anonymous';
      try { id = localStorage.getItem(annotKey) || 'anonymous'; } catch{}
      if(new URLSearchParams(location.search).get('links')==='0') return;
      c.innerHTML = `Quick Links:
        <a href="${base}/meta-v2/index.html">Meta V2</a> ·
        <a href="${base}/">Stage 2</a> ·
        <a href="${base}/api/tasks?stage=2&annotator_id=${encodeURIComponent(id)}&limit=5" target="_blank">Tasks API</a> · 
        <a href="${base}/api/clip?annotator=${encodeURIComponent(id)}" target="_blank">Clip API</a> · 
        <a href="${base}/api/debug?annotator=${encodeURIComponent(id)}" target="_blank">Debug</a>`;
      document.body.appendChild(c);
    })();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/public/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
