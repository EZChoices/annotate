<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoAtlas Stage 2 — Deep Annotation</title>
  <link rel="manifest" href="/public/manifest.webmanifest">
  <link rel="stylesheet" href="/public/styles.css">
  <style>
    .hide{display:none}
    .screen{max-width:720px;margin:0 auto}
    .controls{display:flex;gap:.5rem;margin:.5rem 0}
    textarea.vtt{width:100%;min-height:140px}
    .notice{background:var(--card);border:1px solid var(--border);padding:.6rem .9rem;border-radius:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="screen" id="screen_welcome">
      <h2>Verify transcript, translation, and mark code-switches.</h2>
      <p class="notice hide" id="offlineNotice">You're offline. Work is saved locally and will sync automatically.</p>
      <div id="downloadStatus" class="notice">Ready. Tap Start to load tasks.</div>
      <button id="startBtn" class="primary">Start</button>
    </div>

    <div class="screen hide" id="screen_transcript">
      <h3>Transcript — keep cues 0.6–6.0s, no overlaps</h3>
      <audio id="audio" controls preload="auto"></audio>
      <canvas id="wave" style="width:100%;height:80px;margin:.4rem 0;background:var(--card);border:1px solid var(--border);border-radius:8px"></canvas>
      <div class="controls">
        <button id="zoomOut" class="secondary">- Zoom</button>
        <button id="zoomIn" class="secondary">+ Zoom</button>
        <button id="scrollLeft" class="secondary">◀︎</button>
        <button id="scrollRight" class="secondary">▶︎</button>
      </div>
      <div class="controls">
        <button id="splitBtn" class="secondary">Split</button>
        <button id="mergeBtn" class="secondary">Merge</button>
        <button id="rewindBtn" class="secondary">Rewind 3s</button>
        <button id="undoBtn" class="secondary">Undo</button>
      </div>
      <div id="timeline" style="height:32px;border:1px solid var(--border);border-radius:6px;position:relative;background:var(--card)"></div>
      <label>Cues (WebVTT)</label>
      <textarea id="transcriptVTT" class="vtt" placeholder="WEBVTT\n\n00:00.000 --> 00:02.000\nHello"></textarea>
      <div class="controls">
        <button id="transcriptNext" class="primary">Approve Transcript</button>
      </div>
    </div>

    <div class="screen hide" id="screen_translation">
      <h3>Translation — one translation per cue</h3>
      <label style="display:flex;align-items:center;gap:.5rem"><input type="checkbox" id="lockTranslation" checked> Lock translation timings to transcript</label>
      <label>Translation (WebVTT)</label>
      <textarea id="translationVTT" class="vtt" placeholder="WEBVTT\n\n00:00.000 --> 00:02.000\nHello"></textarea>
      <div class="controls">
        <button id="translationNext" class="primary">Approve Translation</button>
      </div>
    </div>

    <div class="screen hide" id="screen_codeswitch">
      <h3>Code-Switch — press while the switch lasts</h3>
      <div class="controls">
        <button id="btnEN" class="secondary">EN</button>
        <button id="btnFR" class="secondary">FR</button>
        <button id="btnOther" class="secondary">Other</button>
        <button id="nudgeMinus" class="secondary">-200ms</button>
        <button id="nudgePlus" class="secondary">+200ms</button>
        <button id="csUndo" class="secondary">Undo</button>
      </div>
      <label>Code-Switch Spans (WebVTT)</label>
      <textarea id="codeSwitchVTT" class="vtt" placeholder="WEBVTT\n\n00:03.200 --> 00:04.000\nEN"></textarea>
      <div class="controls">
        <button id="csNext" class="primary">Continue</button>
      </div>
    </d
      
          <div class="screen hide" id="screen_speaker">
      <h3>Speaker Attributes (per speaker)</h3>
      <div id="speakerCards"></div>
      <div class="controls">
        <button id="speakerNext" class="primary">Continue</button>
      </div>
    </div>

    <div class="screen hide" id="screen_emotion">
      <h3>Emotion (optional)</h3>
      <div class="controls">
        <button id="btnNeutral" class="secondary">Neutral</button>
        <button id="btnHappy" class="secondary">Happy</button>
        <button id="btnAngry" class="secondary">Angry</button>
        <button id="btnSad" class="secondary">Sad</button>
        <button id="btnExcited" class="secondary">Excited</button>
        <button id="btnOtherEmo" class="secondary">Other</button>
        <button id="emoUndo" class="secondary">Undo</button>
      </div>
      <label>Emotion Spans (WebVTT)</label>
      <textarea id="emotionVTT" class="vtt" placeholder="WEBVTT\n\n00:00.000 --> 00:01.500\nneutral\n"></textarea>
      <div class="controls">
        <button id="emotionNext" class="primary">Continue</button>
      </div>
    </div>
    <div class="screen hide" id="screen_pii">
      <h3>Optional PII / Safety Events</h3>
      <div class="controls">
        <button class="secondary" data-evt="pii_name">PII: Name</button>
        <button class="secondary" data-evt="pii_phone">PII: Phone</button>
        <button class="secondary" data-evt="minor_face">Minor Face</button>
        <button class="secondary" data-evt="political_slogan">Political</button>
        <button class="secondary" data-evt="religious_content">Religious</button>
        <button class="secondary" data-evt="explicit">Explicit</button>
      </div>
      <label>Events (WebVTT)</label>
      <textarea id="eventsVTT" class="vtt" placeholder="WEBVTT\n\n00:01.000 --> 00:03.200\npii_name"></textarea>
      <div class="controls">
        <button id="piiNext" class="primary">Continue</button>
      </div>
    </div>

    <div class="screen hide" id="screen_diar">
      <h3>Diarization (Optional)</h3>
      <p class="notice">Nudge boundaries up to 500ms. Prefill loads from keep table if provided.</p>
      <div id="diarList" class="notice"></div>
      <div class="controls">
        <button id="diarNext" class="primary">Continue</button>
      </div>
    </div>

    <div class="screen hide" id="screen_review">
      <h3>Review & Submit</h3>
      <div id="errorsList" class="notice"></div>
      <div class="controls">
        <button id="submitBtn" class="primary">Submit & Next</button>
      </div>
      <div class="controls">
        <button id="clearLocal" class="secondary">Clear Local Data</button>
      </div>
    </div>
  </div>

  <script src="/public/idb.js"></script>
  <script src="/public/env.js"></script>
  <script src="/public/config.js"></script>
  <script src="/public/vtt.js"></script>
  <script src="/public/timeline.js"></script>
  <script src="/public/waveform.js"></script>
  <script src="/stage2/app.js"></script>
  <script>
    // Quick Links footer for easy switching/debug
    (function(){
      const c = document.createElement('div');
      c.className = 'notice';
      const base = location.origin;
      const annotKey = 'ea_stage2_annotator_id';
      let id = 'anonymous';
      try { id = localStorage.getItem(annotKey) || 'anonymous'; } catch{}
      if(new URLSearchParams(location.search).get('links')==='0') return;
      c.innerHTML = `Quick Links: 
        <a href="${base}/">Meta V2</a> · 
        <a href="${base}/stage2/index.html">Stage 2</a> ·
        <a href="${base}/api/tasks?stage=2&annotator_id=${encodeURIComponent(id)}&limit=5" target="_blank">Tasks API</a> · 
        <a href="${base}/api/clip?annotator=${encodeURIComponent(id)}" target="_blank">Clip API</a> · 
        <a href="${base}/api/debug?annotator=${encodeURIComponent(id)}" target="_blank">Debug</a>`;
      document.body.appendChild(c);
    })();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/public/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
