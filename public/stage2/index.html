<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoAtlas Stage 2 - Deep Annotation</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="stylesheet" href="/styles.css">
  <style>
    .hide{display:none}
    .screen{max-width:720px;margin:0 auto}
    .controls{display:flex;gap:.5rem;margin:.5rem 0}
    textarea.vtt{width:100%;min-height:140px}
    .notice{background:var(--card);border:1px solid var(--border);padding:.6rem .9rem;border-radius:10px}
    .notice.error{border-color:#c0392b;color:#7f1d1d}
    .notice.warn{border-color:#f39c12;color:#7a4f00}
    .stage-menu{display:flex;flex-wrap:wrap;gap:.5rem;margin:0 auto 1rem auto;max-width:720px}
    .stage-menu__link{display:inline-flex;align-items:center;justify-content:center;padding:.45rem .9rem;border-radius:999px;border:1px solid var(--border);background:var(--card);color:inherit;text-decoration:none;font-size:.9rem;transition:background .15s ease,border-color .15s ease,color .15s ease}
    .stage-menu__link:hover{border-color:var(--accent);color:var(--accent)}
    .stage-menu__link.active{background:var(--accent);border-color:var(--accent);color:#fff}
    .translation-list{display:flex;flex-direction:column;gap:.75rem;margin:.75rem 0}
    .translation-row{display:grid;gap:.5rem;grid-template-columns:1fr;align-items:start;border:1px solid var(--border);border-radius:10px;padding:.75rem;background:var(--card)}
    .translation-row__header{display:flex;justify-content:space-between;align-items:center;gap:.75rem;font-size:.9rem;color:var(--muted);flex-wrap:wrap}
    .translation-row__original{background:rgba(0,0,0,0.04);padding:.5rem .65rem;border-radius:6px;font-size:.95rem;line-height:1.4}
    .translation-row__input{width:100%;min-height:72px}
    .translation-row.missing .translation-row__header{color:#b04a00}
    .translation-row__alert{color:#b04a00;font-size:.85rem;margin-top:.25rem}
    .translation-sticky{position:sticky;top:0;background:var(--bg);padding:.5rem 0;z-index:5}
    .diar-timeline{position:relative;height:24px;border:1px solid var(--border);border-radius:8px;background:var(--card);margin:.75rem 0 .25rem;overflow:hidden}
    .diar-timeline.empty{opacity:.65}
    .diar-seg{position:absolute;top:0;bottom:0;border-radius:6px;background:var(--diar-color,rgba(52,152,219,0.55));box-shadow:0 0 0 1px rgba(0,0,0,0.18);cursor:pointer;transition:box-shadow .15s ease,transform .15s ease}
    .diar-seg:hover{box-shadow:0 0 0 2px rgba(0,0,0,0.2);transform:translateY(-1px)}
    .diar-seg.selected{box-shadow:0 0 0 2px var(--accent)}
    .diar-seg .diar-handle{position:absolute;top:0;bottom:0;width:12px;background:rgba(255,255,255,0.85);border:1px solid rgba(0,0,0,0.12);box-shadow:0 0 0 1px rgba(0,0,0,0.05);cursor:ew-resize;touch-action:none;opacity:0;transition:opacity .12s ease}
    .diar-seg:hover .diar-handle,.diar-seg.selected .diar-handle{opacity:1}
    .diar-seg .diar-handle.start{left:0;border-radius:6px 0 0 6px}
    .diar-seg .diar-handle.end{right:0;border-radius:0 6px 6px 0}
    .diar-row{display:flex;gap:.5rem;align-items:center;margin:.25rem 0;padding:.1rem .3rem;border-radius:6px;transition:background .15s ease}
    .diar-row.selected{background:rgba(43,124,255,0.08)}
    .cs-timeline{position:relative;height:72px;border:1px solid var(--border);border-radius:10px;background:var(--card);margin:.75rem 0;overflow:hidden}
    .cs-span{position:absolute;top:12px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:.85rem;color:#fff;cursor:pointer;box-shadow:0 0 0 1px rgba(0,0,0,0.12);transition:box-shadow .15s ease}
    .cs-span__label{pointer-events:none}
    .cs-span.selected{box-shadow:0 0 0 2px var(--accent)}
    .cs-span.active-preview{opacity:.6;pointer-events:none}
    .cs-span--eng{background:rgba(43,124,255,0.35);border:1px solid rgba(43,124,255,0.6)}
    .cs-span--fra{background:rgba(155,89,182,0.35);border:1px solid rgba(155,89,182,0.6)}
    .cs-span--other{background:rgba(22,160,133,0.35);border:1px solid rgba(22,160,133,0.6)}
    .cs-handle{position:absolute;top:0;width:10px;height:100%;background:rgba(255,255,255,0.85);cursor:ew-resize}
    .cs-handle.start{left:0;border-radius:8px 0 0 8px}
    .cs-handle.end{right:0;border-radius:0 8px 8px 0}
    .cs-toast{position:fixed;left:50%;bottom:1.5rem;transform:translateX(-50%);background:rgba(33,33,33,0.92);color:#fff;padding:.6rem 1.2rem;border-radius:999px;box-shadow:0 8px 24px rgba(0,0,0,0.25);opacity:0;pointer-events:none;transition:opacity .2s ease}
    .cs-toast.show{opacity:1}
    .speaker-drawer{margin-top:1rem;border:1px solid var(--border);border-radius:12px;background:var(--card);padding:1rem;display:flex;flex-direction:column;gap:1rem}
    .speaker-drawer__header h4{margin:0;font-size:1.05rem}
    .speaker-drawer__hint{margin:0;color:var(--muted);font-size:.9rem}
    .speaker-card-list{display:flex;flex-direction:column;gap:.85rem}
    .speaker-card{border:1px solid var(--border);border-radius:10px;padding:.85rem;background:rgba(0,0,0,0.02);display:flex;flex-direction:column;gap:.75rem}
    .speaker-card__title{margin:0 0 .75rem 0;font-size:1rem;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    .speaker-card__subtitle{color:var(--muted);font-size:.85rem}
    .speaker-card label{display:flex;flex-direction:column;gap:.35rem;font-size:.9rem;margin-bottom:.65rem}
    .speaker-card select{width:100%;padding:.65rem .75rem;border-radius:8px;border:1px solid var(--border);font-size:1rem;background:#fff}
    .speaker-card select:focus{outline:2px solid var(--accent);outline-offset:1px}
    .speaker-card label:last-of-type{margin-bottom:0}
    .speaker-drawer__submit{width:100%;padding:.85rem;font-size:1rem}
    .speaker-drawer__error{font-size:.9rem}
    .emotion-safety{display:flex;flex-direction:column;gap:1.25rem;margin:1rem 0}
    .emotion-button-grid,.safety-button-grid{display:flex;flex-wrap:wrap;gap:.5rem}
    .emotion-button-grid button,.safety-button-grid button{flex:1 1 calc(50% - .5rem);min-width:120px}
    .emotion-safety__timeline{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:1rem;display:flex;flex-direction:column;gap:1rem}
    .emotion-lane{display:flex;flex-direction:column;gap:.4rem}
    .emotion-lane__label{font-size:.85rem;color:var(--muted);display:flex;align-items:center;justify-content:space-between}
    .emotion-lane__track{position:relative;height:44px;border-radius:10px;background:rgba(0,0,0,0.03);overflow:hidden}
    .emotion-span{position:absolute;top:6px;bottom:6px;border-radius:8px;color:#fff;font-weight:600;font-size:.8rem;display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 1px rgba(0,0,0,0.12);cursor:pointer;transition:box-shadow .15s ease}
    .emotion-span.selected{box-shadow:0 0 0 2px var(--accent)}
    .emotion-span__label{pointer-events:none;padding:0 .5rem;text-transform:capitalize}
    .emotion-span__handle{position:absolute;top:0;bottom:0;width:18px;background:rgba(255,255,255,0.75);cursor:ew-resize}
    .emotion-span__handle.start{left:0;border-radius:8px 0 0 8px}
    .emotion-span__handle.end{right:0;border-radius:0 8px 8px 0}
    .emotion-span.dragging{opacity:.85}
    .emotion-span.preview{opacity:.6;border-style:dashed}
    .safety-lane__track{position:relative;height:40px;border-radius:10px;background:rgba(0,0,0,0.03);overflow:hidden}
    .safety-event{position:absolute;top:8px;bottom:8px;border-radius:6px;min-width:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.75rem;cursor:grab;transition:box-shadow .15s ease}
    .safety-event.selected{box-shadow:0 0 0 2px var(--accent)}
    .safety-event__label{pointer-events:none;padding:0 .4rem;text-transform:uppercase;font-size:.65rem}
    .safety-event.dragging{opacity:.9;cursor:grabbing}
    .safety-event__handle{position:absolute;top:0;bottom:0;width:16px;background:rgba(255,255,255,0.75);cursor:ew-resize}
    .safety-event__handle.start{left:0;border-radius:6px 0 0 6px}
    .safety-event__handle.end{right:0;border-radius:0 6px 6px 0}
    .flag-toggle{display:flex;align-items:center;gap:.5rem;font-size:.95rem}
    .flag-toggle input{width:1.25rem;height:1.25rem}
    .emotion-safety__actions{display:flex;flex-wrap:wrap;gap:.5rem}
    .emotion-safety__actions button{flex:1 1 calc(33.33% - .5rem);min-width:120px}
    .emotion-safety__empty{font-size:.9rem;color:var(--muted)}
    @media (min-width:720px){
      .speaker-card{padding:1rem}
      .emotion-button-grid button,.safety-button-grid button{flex:0 0 auto;min-width:140px}
      .emotion-safety__actions button{flex:0 0 auto;min-width:140px}
    }
  </style>
</head>
<body>
  <script>
    (function(){
      let dbg = false;
      try{
        if(location.search.includes('debug=0')) dbg = false;
        else if(location.search.includes('debug=1')) dbg = true;
        else dbg = localStorage.getItem('ea_debug') === '1';
      }catch{}
      if(dbg){
        const bar=document.createElement('div');
        bar.style.cssText='position:fixed;left:8px;bottom:8px;z-index:9998;background:#0a0a0a;color:#fff;padding:6px 8px;border-radius:6px;font:12px monospace;opacity:.9';
        const a1=document.createElement('a'); a1.href='/api/env_names'; a1.textContent='env-names'; a1.style.color='#7dd3fc'; a1.target='_blank';
        const a2=document.createElement('a'); a2.href='#'; a2.textContent='prefill-check'; a2.style.cssText='color:#86efac;margin-left:10px';
        a2.onclick=(e)=>{e.preventDefault();try{const it=(window.EAQ&&EAQ.state&&typeof currentItem==='function')?currentItem():null; if(!it){ alert('No manifest item loaded'); return;} window.open('/api/prefill_check?file='+encodeURIComponent(it.asset_id),'_blank');}catch(err){alert(err);}};
        bar.appendChild(a1); bar.appendChild(a2); document.body.appendChild(bar);
      }
    })();
  </script>

    <nav class="stage-menu" aria-label="Stage 2 menu">
      <a href="/stage2/index.html" class="stage-menu__link active">Annotation Workspace</a>
      <a href="/stage2/qa-dashboard.html" class="stage-menu__link">QA Dashboard</a>
    </nav>
    <div class="screen" id="screen_welcome">
      <h2>Verify transcript, translation, and mark code-switches.</h2>
      <p class="notice hide" id="offlineNotice">You're offline. Work is saved locally and will sync automatically.</p>
      <div id="downloadStatus" class="notice">Ready. Tap Start to load tasks.</div>
      <button id="startBtn" class="primary">Start</button>
    </div>

    <div class="screen hide" id="screen_transcript">
      <h3>Transcript - keep cues 0.6-6.0s, no overlaps</h3>
      <audio id="audio" controls preload="auto"></audio>
      <canvas id="wave" style="width:100%;height:80px;margin:.4rem 0;background:var(--card);border:1px solid var(--border);border-radius:8px"></canvas>
      <div class="controls">
        <button id="zoomOut" class="secondary">- Zoom</button>
        <button id="zoomIn" class="secondary">+ Zoom</button>
        <button id="scrollLeft" class="secondary"><<</button>
        <button id="scrollRight" class="secondary">>></button>
      </div>
      <div class="controls">
        <button id="splitBtn" class="secondary">Split</button>
        <button id="splitAllBtn" class="secondary">Split All</button>
        <button id="mergeBtn" class="secondary">Merge</button>
        <button id="rewindBtn" class="secondary">Rewind 3s</button>
        <button id="undoBtn" class="secondary">Undo</button>
      </div>
      <div id="timeline" style="height:32px;border:1px solid var(--border);border-radius:6px;position:relative;background:var(--card)"></div>
      <label>Cues (WebVTT)</label>
      <textarea id="transcriptVTT" class="vtt" placeholder="WEBVTT\n\n00:00.000 --> 00:02.000\nHello"></textarea>
      <div class="controls">
        <button id="transcriptNext" class="primary">Approve Transcript</button>
      </div>
    </div>

    <div class="screen hide" id="screen_translation">
      <h3>Translation - one translation per cue</h3>
      <label style="display:flex;align-items:center;gap:.5rem"><input type="checkbox" id="lockTranslation" checked> Lock translation timings to transcript</label>
      <div class="translation-sticky notice warn hide" id="translationStickyNotice"></div>
      <div id="translationList" class="translation-list" aria-live="polite"></div>
      <textarea id="translationVTT" class="vtt hide" aria-hidden="true" tabindex="-1"></textarea>
      <div class="controls">
        <button id="translationNext" class="primary">Approve Translation</button>
      </div>
    </div>

    <div class="screen hide" id="screen_codeswitch">
      <h3>Code-Switch - press while the switch lasts</h3>
      <div class="controls">
        <button class="secondary" data-lang="eng" id="btnEN">EN</button>
        <button class="secondary" data-lang="fra" id="btnFR">FR</button>
        <button class="secondary" data-lang="other" id="btnOther">Other</button>
        <button class="secondary" id="csUndo">Undo</button>
        <button class="secondary" id="csRedo">Redo</button>
      </div>
      <div class="controls" id="diarControls">
        <button class="secondary" id="diarAddBoundary" type="button">Add boundary @ playhead</button>
        <button class="secondary" id="diarMergePrev" type="button">Merge with previous</button>
        <button class="secondary" id="diarMergeNext" type="button">Merge with next</button>
      </div>
      <div class="controls">
        <button class="secondary" id="nudgeStartMinus">Start -200ms</button>
        <button class="secondary" id="nudgeStartPlus">Start +200ms</button>
        <button class="secondary" id="nudgeEndMinus">End -200ms</button>
        <button class="secondary" id="nudgeEndPlus">End +200ms</button>
      </div>
      <div id="diarTimeline" class="diar-timeline" aria-label="Speaker diarization timeline"></div>
      <div id="codeSwitchTimeline" class="cs-timeline" aria-live="polite"></div>
      <div id="codeSwitchNotice" class="notice warn hide"></div>
      <textarea id="codeSwitchVTT" class="vtt hide" aria-hidden="true" tabindex="-1"></textarea>
      <aside id="speakerDrawer" class="speaker-drawer" aria-labelledby="speakerDrawerTitle">
        <div class="speaker-drawer__header">
          <h4 id="speakerDrawerTitle">Speaker Attributes</h4>
          <p class="speaker-drawer__hint">Set the apparent gender, age band, and dialect sub-region for each speaker.</p>
        </div>
        <div id="speakerDrawerError" class="notice error hide speaker-drawer__error"></div>
        <div id="speakerCards" class="speaker-card-list" aria-live="polite"></div>
        <button id="csNext" class="primary speaker-drawer__submit">Continue</button>
      </aside>
    </div>

    <div class="screen hide" id="screen_emotionSafety">
      <h3>Emotion &amp; Safety (optional)</h3>
      <p class="notice">Mark emotion changes by pressing and holding a button, and tap to add safety or PII events. These annotations are optional.</p>
      <section class="emotion-safety">
        <div>
          <h4 style="margin:0 0 .5rem 0;">Emotion spans</h4>
          <p style="margin:.25rem 0 0 0;font-size:.9rem;color:var(--muted);">Press and hold while the emotion lasts. Release to finish and drag edges up to 200&nbsp;ms to fine-tune.</p>
          <div class="emotion-button-grid" id="emotionButtons"></div>
        </div>
        <div>
          <h4 style="margin:0 0 .5rem 0;">Safety &amp; PII events</h4>
          <p style="margin:.25rem 0 0 0;font-size:.9rem;color:var(--muted);">Tap a button at the moment the content occurs. Events must cover at least 1.5&nbsp;s; drag to adjust if needed.</p>
          <div class="safety-button-grid" id="safetyButtons"></div>
          <label class="flag-toggle"><input type="checkbox" id="clipFlagToggle"> Flag clip for safety review</label>
        </div>
        <div class="emotion-safety__timeline" id="emotionSafetyTimeline">
          <div class="emotion-lane">
            <div class="emotion-lane__label">
              <span>Emotion</span>
              <span id="emotionEmptyNotice" class="emotion-safety__empty hide">No emotion spans</span>
            </div>
            <div class="emotion-lane__track" id="emotionLane" aria-label="Emotion timeline" role="list"></div>
          </div>
          <div class="emotion-lane">
            <div class="emotion-lane__label">
              <span>Safety / PII</span>
              <span id="safetyEmptyNotice" class="emotion-safety__empty hide">No events</span>
            </div>
            <div class="safety-lane__track" id="safetyLane" aria-label="Safety timeline" role="list"></div>
          </div>
        </div>
        <div class="emotion-safety__actions">
          <button class="secondary" id="emotionUndo">Emotion Undo</button>
          <button class="secondary" id="emotionRedo">Emotion Redo</button>
          <button class="secondary" id="emotionDelete">Delete Emotion</button>
        </div>
        <div class="emotion-safety__actions">
          <button class="secondary" id="safetyUndo">Event Undo</button>
          <button class="secondary" id="safetyRedo">Event Redo</button>
          <button class="secondary" id="safetyDelete">Delete Event</button>
        </div>
      </section>
      <div class="controls">
        <button id="emotionSafetyNext" class="primary">Continue</button>
      </div>
    </div>

    <div class="screen hide" id="screen_diar">
      <h3>Diarization (Optional)</h3>
      <p class="notice">Nudge boundaries up to 500ms. Prefill loads from keep table if provided.</p>
      <div id="diarList" class="notice"></div>
      <div class="controls">
        <button id="diarNext" class="primary">Continue</button>
      </div>
    </div>

    <div class="screen hide" id="screen_review">
      <h3>Review & Submit</h3>
      <div id="errorsList" class="notice hide"></div>
      <div class="controls">
        <button id="submitBtn" class="primary">Submit & Next</button>
      </div>
      <div class="controls">
        <button id="clearLocal" class="secondary">Clear Local Data</button>
      </div>
    </div>
  </div>
  <div id="csToast" class="cs-toast" role="status" aria-live="polite"></div>

  <script src="/app.buildmeta.js?v=1730135595"></script>
  <script src="/idb.js?v=1730135595"></script>
  <script src="/env.js?v=1730135595"></script>
  <script src="/config.js?v=1730135595"></script>
  <script src="/vtt.js?v=1730135595"></script>
  <script src="/timeline.js?v=1730135595"></script>
  <script src="/waveform.js?v=1730135595"></script>
  <script src="/stage2/irr.js?v=1730135595"></script>
  <script src="/stage2/qa_metrics.js?v=1730135595"></script>
  <<script src="/stage2/selftest.js?v=1730135595"></script>>
  <script src="/stage2/debug.js?v=1730135595"></script>
  <script src="/stage2/app.js?v=1730135595"></script>
  <script>
    // Quick Links footer for easy switching/debug
    (function(){
      const container = document.createElement('div');
      container.className = 'notice';
      const base = location.origin;
      const annotKey = 'ea_stage2_annotator_id';
      let id = 'anonymous';
      try { id = localStorage.getItem(annotKey) || 'anonymous'; } catch{}
      if(new URLSearchParams(location.search).get('links')==='0') return;
      container.innerHTML = [
        'Quick Links:',
        `<a href="${base}/meta-v2/index.html">Meta V2</a> &bull;`,
        `<a href="${base}/">Stage 2</a> &bull;`,
        `<a href="${base}/stage2/qa-dashboard.html">QA Dashboard</a> &bull;`,
        `<a href="${base}/api/tasks?stage=2&annotator_id=${encodeURIComponent(id)}&limit=5" target="_blank">Tasks API</a> &bull;`,
        `<a href="${base}/api/clip?annotator=${encodeURIComponent(id)}" target="_blank">Clip API</a> &bull;`,
        `<a href="${base}/api/debug?annotator=${encodeURIComponent(id)}" target="_blank">Debug</a> &bull;`,
        'Build <span data-build-sha>dev</span>'
      ].join(' ');
      document.body.appendChild(container);
    })();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }
  </script>
  <div id='diag' style='position:fixed;right:8px;bottom:8px;background:#0008;color:#fff;padding:6px 8px;border-radius:8px;font:12px monospace;z-index:9999'></div>
</body>
</html>







